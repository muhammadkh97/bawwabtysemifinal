# ุชุฏููู ุฏูุงู SECURITY DEFINER
## Security DEFINER Functions Audit

**ุงูุชุงุฑูุฎ:** 10 ููุงูุฑ 2026  
**ุงููุดุฑูุน:** bawwabtysemifinal

---

## ๐ ููุฎุต ุงูุฏูุงู ุงูููุฌูุฏุฉ

ุชู ุงูุนุซูุฑ ุนูู **8 ุฏูุงู** ุชุณุชุฎุฏู `SECURITY DEFINER` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:

| # | ุงุณู ุงูุฏุงูุฉ | ุงูุญุงูุฉ ุงูุฃูููุฉ | ูุญุชุงุฌ ุชุญุฏูุซ |
| :--- | :--- | :--- | :--- |
| 1 | `accept_staff_invitation` | โ๏ธ ูุญุชุงุฌ ูุฑุงุฌุนุฉ | ูุนู |
| 2 | `archive_chat` | โ๏ธ ูุญุชุงุฌ ูุฑุงุฌุนุฉ | ูุนู |
| 3 | `assign_order_to_driver` | โ๏ธ ูุญุชุงุฌ ูุฑุงุฌุนุฉ | ูุนู |
| 4 | `cleanup_old_notifications` | โ๏ธ ูุญุชุงุฌ ูุฑุงุฌุนุฉ | ูุนู |
| 5 | `create_notification` | โ ุขููุฉ ูุณุจูุงู | ูุง |
| 6 | `create_or_get_chat` | โ๏ธ ูุญุชุงุฌ ูุฑุงุฌุนุฉ | ูุนู |
| 7 | `create_order_secure` | โ ุขููุฉ (ุชู ุฅูุดุงุคูุง) | ูุง |
| 8 | `create_payout_request_secure` | โ ุขููุฉ (ุชู ุฅูุดุงุคูุง) | ูุง |

---

## ๐ ุชุญููู ุชูุตููู

### 1. accept_staff_invitation

**ุงููุดููุฉ:**
- ูุง ููุฌุฏ ุชุญูู ูู ุฃู `p_user_id` ูู ููุณู `auth.uid()`
- ูููู ูุฃู ูุณุชุฎุฏู ูุจูู ุฏุนูุฉ ุจุงุณู ูุณุชุฎุฏู ุขุฎุฑ

**ุงูุญู ุงููุทููุจ:**
```sql
-- ุฅุถุงูุฉ ูู ุจุฏุงูุฉ ุงูุฏุงูุฉ:
IF auth.uid() IS NULL OR auth.uid() != p_user_id THEN
  RETURN jsonb_build_object(
    'success', false,
    'error', 'ุบูุฑ ูุตุฑุญ ูู ุจูุจูู ูุฐู ุงูุฏุนูุฉ'
  );
END IF;
```

---

### 2. archive_chat

**ุงููุดููุฉ:**
- ูุง ููุฌุฏ ุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ูู ุตุงุญุจ ุงููุญุงุฏุซุฉ
- ูููู ูุฃู ูุณุชุฎุฏู ุฃุฑุดูุฉ ุฃู ูุญุงุฏุซุฉ

**ุงูุญู ุงููุทููุจ:**
```sql
-- ุฅุถุงูุฉ ูู ุจุฏุงูุฉ ุงูุฏุงูุฉ:
IF NOT EXISTS (
  SELECT 1 FROM chats
  WHERE id = p_chat_id
    AND (customer_id = auth.uid() OR vendor_id IN (
      SELECT id FROM stores WHERE user_id = auth.uid()
    ))
) THEN
  RETURN false;
END IF;
```

---

### 3. assign_order_to_driver

**ุงููุดููุฉ:**
- ูุง ููุฌุฏ ุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ุงูุญุงูู ูู ุฃุฏูู ุฃู dispatcher
- ูููู ูุฃู ุณุงุฆู ุชุนููู ููุณู ูุฃู ุทูุจ

**ุงูุญู ุงููุทููุจ:**
```sql
-- ุฅุถุงูุฉ ูู ุจุฏุงูุฉ ุงูุฏุงูุฉ:
IF NOT EXISTS (
  SELECT 1 FROM users
  WHERE id = auth.uid()
    AND role IN ('admin', 'dispatcher')
) THEN
  RETURN jsonb_build_object(
    'success', false,
    'error', 'ุบูุฑ ูุตุฑุญ ูู ุจุชุนููู ุงูุณุงุฆููู'
  );
END IF;
```

---

### 4. cleanup_old_notifications

**ุงููุดููุฉ:**
- ูุง ููุฌุฏ ุชุญูู ูู ุงูุตูุงุญูุงุช
- ูููู ูุฃู ูุณุชุฎุฏู ุญุฐู ุฌููุน ุงูุฅุดุนุงุฑุงุช ุงููุฏููุฉ

**ุงูุญู ุงููุทููุจ:**
```sql
-- ุฅุถุงูุฉ ูู ุจุฏุงูุฉ ุงูุฏุงูุฉ:
IF NOT EXISTS (
  SELECT 1 FROM users
  WHERE id = auth.uid() AND role = 'admin'
) THEN
  RAISE EXCEPTION 'ุบูุฑ ูุตุฑุญ ูู ุจุญุฐู ุงูุฅุดุนุงุฑุงุช';
END IF;
```

---

### 5. create_notification โ

**ุงูุญุงูุฉ:** ุขููุฉ ูุณุจูุงู

**ุงูุชุญูู ุงูููุฌูุฏ:**
- ูุชุญูู ูู `auth.uid() IS NULL`
- ูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู ุงููุณุชูุฏู
- ูุชุญูู ูู ุตุญุฉ ุงูุฃููููุฉ

**ููุงุญุธุฉ:** ูููู ุฅุถุงูุฉ ุชุญูู ุฅุถุงูู ูููุน ุฅุฑุณุงู ุฅุดุนุงุฑุงุช spam

---

### 6. create_or_get_chat

**ุงููุดููุฉ:**
- ูุญุตู ุนูู ุฏูุฑ ุงููุณุชุฎุฏู ููู ูุง ูุณุชุฎุฏูู
- ูุง ููุฌุฏ ุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ูู ุงูุนููู ุฃู ุงูุจุงุฆุน

**ุงูุญู ุงููุทููุจ:**
```sql
-- ุฅุถุงูุฉ ูู ุจุฏุงูุฉ ุงูุฏุงูุฉ:
IF auth.uid() != p_customer_id AND NOT EXISTS (
  SELECT 1 FROM stores
  WHERE id = p_vendor_id AND user_id = auth.uid()
) THEN
  RAISE EXCEPTION 'ุบูุฑ ูุตุฑุญ ูู ุจุฅูุดุงุก ูุฐู ุงููุญุงุฏุซุฉ';
END IF;
```

---

### 7. create_order_secure โ

**ุงูุญุงูุฉ:** ุขููุฉ (ุชู ุฅูุดุงุคูุง ูู ุงูุฅุตูุงุญุงุช)

**ุงูุชุญูู ุงูููุฌูุฏ:**
- ูุชุญูู ูู `auth.uid() IS NULL`
- ูุชุญูู ูู `auth.uid() = p_customer_id`
- ูุชุญูู ูู ุฌููุน ุงูุฃุณุนุงุฑ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ูุชุญูู ูู ุงููุฎุฒูู
- ูุชุญูู ูู ููุจููุงุช ุงูุฎุตู

---

### 8. create_payout_request_secure โ

**ุงูุญุงูุฉ:** ุขููุฉ (ุชู ุฅูุดุงุคูุง ูู ุงูุฅุตูุงุญุงุช)

**ุงูุชุญูู ุงูููุฌูุฏ:**
- ูุชุญูู ูู `auth.uid() IS NULL`
- ูุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ูู ุตุงุญุจ ุงููุชุฌุฑ
- ูุชุญูู ูู ุงูุฑุตูุฏ ุงููุชุงุญ
- ูุดูุฑ ูุนูููุงุช ุงูุจูู

---

## ๐๏ธ ุฎุทุฉ ุงูุฅุตูุงุญ

### ุงูุฃููููุฉ ุงูุนุงููุฉ (ูุฌุจ ุฅุตูุงุญูุง ููุฑุงู)

1. **assign_order_to_driver** - ูููู ุงุณุชุบูุงููุง ูุชุนููู ุทูุจุงุช
2. **archive_chat** - ูููู ุงุณุชุบูุงููุง ูุฃุฑุดูุฉ ูุญุงุฏุซุงุช ุงูุขุฎุฑูู
3. **accept_staff_invitation** - ูููู ุงุณุชุบูุงููุง ููุจูู ุฏุนูุงุช ุงูุขุฎุฑูู

### ุงูุฃููููุฉ ุงููุชูุณุทุฉ

4. **create_or_get_chat** - ูููู ุงุณุชุบูุงููุง ูุฅูุดุงุก ูุญุงุฏุซุงุช ุบูุฑ ูุตุฑุญ ุจูุง
5. **cleanup_old_notifications** - ูููู ุงุณุชุบูุงููุง ูุญุฐู ุฅุดุนุงุฑุงุช

---

## ๐ ููุงุญุธุงุช

1. **ุฌููุน ุฏูุงู SECURITY DEFINER ูุฌุจ ุฃู ุชุจุฏุฃ ุจุชุญูู ูู ุงูุตูุงุญูุงุช**
2. **ุงุณุชุฎุฏู `SET search_path = public` ูููุน schema hijacking**
3. **ูุง ุชุนุชูุฏ ุนูู ุจูุงูุงุช ูู Frontend ุจุฏูู ุชุญูู**
4. **ุณุฌูู ุฌููุน ุงูุนูููุงุช ุงูุญุณุงุณุฉ ูู audit log**

---

## โ ุงูุฏูุงู ุงูุขููุฉ (ูุง ุชุญุชุงุฌ ุชุญุฏูุซ)

- `create_order_secure` โ
- `create_payout_request_secure` โ
- `create_notification` โ (ูุน ุชุญูุธ ุจุณูุท)

---

## ๐ ุงูุชูุตูุงุช ุงูุนุงูุฉ

1. **ุฅุถุงูุฉ Rate Limiting ุนูู ูุณุชูู ุงูุฏุงูุฉ:**
   ```sql
   -- ูุซุงู: ููุน ุงุณุชุฏุนุงุก ุงูุฏุงูุฉ ุฃูุซุฑ ูู 10 ูุฑุงุช ูู ุงูุฏูููุฉ
   IF (SELECT COUNT(*) FROM function_calls 
       WHERE user_id = auth.uid() 
         AND function_name = 'function_name'
         AND created_at > NOW() - INTERVAL '1 minute') > 10 THEN
     RAISE EXCEPTION 'ุชู ุชุฌุงูุฒ ุงูุญุฏ ุงูุฃูุตู ููุทูุจุงุช';
   END IF;
   ```

2. **ุฅุถุงูุฉ Audit Logging:**
   ```sql
   -- ุชุณุฌูู ูู ุงุณุชุฏุนุงุก ููุฏุงูุฉ
   INSERT INTO audit_log (
     user_id,
     action,
     table_name,
     record_id,
     details,
     created_at
   ) VALUES (
     auth.uid(),
     'function_call',
     'function_name',
     v_record_id,
     jsonb_build_object('params', ...),
     NOW()
   );
   ```

3. **ุงุณุชุฎุฏุงู RAISE EXCEPTION ุจุฏูุงู ูู RETURN ููุฃุฎุทุงุก ุงูุฃูููุฉ:**
   - `RETURN` ูููู ุชุฌุงููู
   - `RAISE EXCEPTION` ูููู ุงูุชูููุฐ ููุฑุงู

---

**ุขุฎุฑ ุชุญุฏูุซ:** 10 ููุงูุฑ 2026
