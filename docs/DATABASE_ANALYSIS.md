# ๐ ุชุญููู ุจููุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุนููุฉ

## โ ุงููุชุงุฆุฌ

### ุฌุฏูู users - ุงูุจููุฉ ุงููุนููุฉ:

| ุงูุนููุฏ | ุงูููุน | ุฅูุฒุงูู | ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ | ุงูุญุงูุฉ |
|--------|-------|--------|-------------------|--------|
| id | uuid | ูุนู | uuid_generate_v4() | โ ุฌุงูุฒ |
| email | text | ูุนู | - | โ ุฌุงูุฒ |
| full_name | text | ูุนู | - | โ ุฌุงูุฒ |
| name | text | ูุง | - | โ ุฌุงูุฒ |
| phone | text | ูุง | - | โ ุฌุงูุฒ |
| **role** | **user_role (ENUM)** | ูุนู | 'customer' | โ๏ธ ENUM |
| user_role | text | ูุง | - | โ๏ธ ุชูุฑุงุฑ |
| avatar_url | text | ูุง | - | โ ุฌุงูุฒ |
| is_active | boolean | ูุง | true | โ ุฌุงูุฒ |
| vendor_id | uuid | ูุง | - | โ ุฌุงูุฒ |
| loyalty_points | integer | ูุง | 0 | โ ุฌุงูุฒ |
| created_at | timestamptz | ูุง | now() | โ ุฌุงูุฒ |
| updated_at | timestamptz | ูุง | now() | โ ุฌุงูุฒ |
| total_earned_points | integer | ูุง | 0 | โ ุฌุงูุฒ |
| referral_code | text | ูุง | - | โ ุฌุงูุฒ |
| date_of_birth | date | ูุง | - | โ ุฌุงูุฒ |
| gender | text | ูุง | - | โ ุฌุงูุฒ |
| country | text | ูุง | - | โ ุฌุงูุฒ |
| preferred_currency | text | ูุง | 'JOD' | โ ุฌุงูุฒ |

---

## ๐ ุงูููุงุญุธุงุช ุงููุงูุฉ

### โ๏ธ ูุดููุฉ: ุชูุฑุงุฑ ุนููุฏ ุงูุฏูุฑ

ููุฌุฏ **ุนููุฏุงู ููุฏูุฑ**:
1. **`role`** - ููุน `user_role` (ENUM) - ุงูุนููุฏ ุงูุฑุฆูุณู
2. **`user_role`** - ููุน `text` - ุนููุฏ ููุฑุฑ

**ุงูุฎุทุฃ ุงูุฐู ุญุฏุซ:**
```sql
ERROR: COALESCE types user_role and text cannot be matched
```

**ุงูุณุจุจ:** ูุง ูููู ุฏูุฌ ENUM ูุน TEXT ูุจุงุดุฑุฉ ูู COALESCE

**ุงูุญู:** ุงุณุชุฎุฏุงู CAST ุฃู ุงุณุชุฎุฏุงู ุนููุฏ ูุงุญุฏ ููุท

---

## ๐ง Triggers ุงูููุฌูุฏุฉ

### 1. **sync_users_aliases_trigger**
- **ูุชู:** BEFORE INSERT/UPDATE
- **ุงููุธููุฉ:** ูุฒุงููุฉ ุงูุฃุณูุงุก ุงูุจุฏููุฉ (name, full_name)
- **ุงูุญุงูุฉ:** โ ูุนูู

### 2. **trigger_create_store_on_user_insert**
- **ูุชู:** AFTER INSERT/UPDATE
- **ุงููุธููุฉ:** ุฅูุดุงุก store ุชููุงุฆู ููู vendor
- **ุงูุญุงูุฉ:** โ ูุนูู

### 3. **update_users_updated_at**
- **ูุชู:** BEFORE UPDATE
- **ุงููุธููุฉ:** ุชุญุฏูุซ updated_at ุชููุงุฆูุงู
- **ุงูุญุงูุฉ:** โ ูุนูู

---

## ๐ RLS Policies

| ุงูุณูุงุณุฉ | ุงูุฃูุฑ | ุงูุดุฑุท | ุงูุญุงูุฉ |
|---------|-------|-------|--------|
| Users can view own profile | SELECT | auth.uid() = id | โ |
| Users can update own profile | UPDATE | auth.uid() = id | โ |
| Admins have full access | ALL | is_admin() | โ |

---

## ๐ฏ ุงูุชุญุฏูุซุงุช ุงููุทููุจุฉ

### 1. ุชุญุฏูุซ auth.ts โ
- ุงุณุชุฎุฏุงู `role` (enum) ุจุฏูุงู ูู `user_role`
- ุงุณุชุฎุฏุงู `full_name` ูุฃุณุงุณู
- ุงูุชุนุงูู ูุน ENUM ุจุดูู ุตุญูุญ

### 2. ุชุญุฏูุซ callback page โ
- ุงุณุชุฎุฏุงู ุงูุฃุนูุฏุฉ ุงูุตุญูุญุฉ
- ุงูุชุนุงูู ูุน role ูู ENUM
- ุงุณุชุฎุฏุงู full_name

### 3. ุฅูุดุงุก ุฏุงูุฉ ูุณุงุนุฏุฉ โ
- ุฏุงูุฉ ูุชุญููู role ุฅูู string
- ุงูุชุนุงูู ูุน ุญุงูุงุช OAuth

---

## ๐ ููู role ุงููุณููุญุฉ (ENUM)

ุจุญุงุฌุฉ ููุชุญูู ูู ููู ุงูู ENUM ุงููุณููุญุฉ:

```sql
SELECT enumlabel 
FROM pg_enum 
WHERE enumtypid = 'user_role'::regtype
ORDER BY enumsortorder;
```

**ุงูููู ุงููุชููุนุฉ:**
- customer
- vendor
- driver
- admin
- restaurant

---

## โ ุงูุฎูุงุตุฉ

ุงูุจููุฉ ุงูุญุงููุฉ **ููุชุงุฒุฉ ูููุงุณุจุฉ ูู OAuth** ูุน ุชุนุฏููุงุช ุจุณูุทุฉ:

1. โ ุฌุฏูู users ููุฌูุฏ ููุงูู
2. โ auth.users ููุฌูุฏ (Supabase)
3. โ Triggers ุชุนูู ุชููุงุฆูุงู
4. โ RLS ูุญูู ุจุดูู ุตุญูุญ
5. โ๏ธ ุชูุฑุงุฑ role/user_role (ูููู ุงูุชุนุงูู ูุนู)

**ุณุฃููู ุงูุขู ุจุชุญุฏูุซ ุงูููุฏ ููุชูุงูู ูุน ุงูุจููุฉ ุงููุนููุฉ!**
