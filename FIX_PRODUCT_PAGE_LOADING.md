# ๐ง ุฅุตูุงุญ ูุดููุฉ ุตูุญุฉ ุฅุถุงูุฉ ุงูููุชุฌ

## ุงููุดููุฉ
ุนูุฏ ุงูุฐูุงุจ ูุตูุญุฉ ุฅุถุงูุฉ ุงูููุชุฌุ ุชุธูุฑ ุฑุณุงูุฉ "ุฌุงุฑู ุงูุชุญูู ูู ุงูุตูุงุญูุงุช" ูุชุจูู ุงูุตูุญุฉ ุชูู ุจุฏูู ุชููู.

## ุงูุณุจุจ ุงูุฌุฐุฑู
ุงููุดููุฉ ูุงูุช ูู ุซูุงุซุฉ ุฃูุงูู:

### 1๏ธโฃ **ุญููุฉ ูุง ุชูุชูู ูู ProtectedRoute**
```
ProtectedRoute ูุญุงูู ุฌูุจ ุงูุจูุงูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
โ ูููู ูุง ููุชูู ุฃุจุฏุงู (ูุง ููุฌุฏ timeout)
โ ุงูุตูุญุฉ ุชุจูู ูู ุญุงูุฉ loading ููุฃุจุฏ
```

### 2๏ธโฃ **ุณูุงุณุงุช RLS ุฎุงุทุฆุฉ ููููุชุฌุงุช**
```
ุงูุณูุงุณุฉ ุงููุฏููุฉ:
- ููุท ุงูููุชุฌุงุช ุงููุนุชูุฏุฉ (status = 'approved') ูููู ุงููุตูู ุฅูููุง
โ ููู ุงูููุชุฌ ุงูุฌุฏูุฏ ูููู ุจุญุงูุฉ 'draft' ุฃู 'pending'
โ ูุง ูุณุชุทูุน ุงูุจุงุฆุน ุฅุถุงูุฉ ุงูููุชุฌ!
```

### 3๏ธโฃ **ุนุฏู ูุฌูุฏ error handling**
```
ูู ุญุตู ุฎุทุฃุ ูุง ุชุธูุฑ ุฑุณุงูุฉ ูุงุถุญุฉ ูููุณุชุฎุฏู
โ ุงููุณุชุฎุฏู ูุฑู ุดุงุดุฉ ุชุญููู ุจุฏูู ูุนุฑูุฉ ุงูุณุจุจ
```

---

## ุงูุญู ุงููุทุจู โ

### ุงูุฎุทูุฉ 1: ุฅุถุงูุฉ Timeout ูู ProtectedRoute
```typescript
// ุชุนุฏูู: ุฅุถุงูุฉ timeout 5 ุซูุงูู
const timeoutPromise = new Promise((_, reject) => 
  setTimeout(() => reject(new Error('Timeout')), 5000)
);

// ุงููุญุงููุฉ ูุงูู timeout ูุนุงู
const { data } = await Promise.race([
  fetchPromise,
  timeoutPromise
]);
```

**ุงููุงุฆุฏุฉ:**
- ูู ุงูู database ุจุทูุก โ ุจุนุฏ 5 ุซูุงูู ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ
- ุงูุตูุญุฉ ูุง ุชุจูู ูุนููุฉ ููุฃุจุฏ

---

### ุงูุฎุทูุฉ 2: ุฅุตูุงุญ RLS Policies
```sql
-- ุงูุณูุงุณุงุช ุงูุฌุฏูุฏุฉ:

-- 1๏ธโฃ ุงูุนุงูุฉ ูุฑูู ุงูููุชุฌุงุช ุงููุนุชูุฏุฉ ููุท
CREATE POLICY "public_view_approved_products" ON products 
  FOR SELECT 
  USING (status = 'approved' AND is_active = true);

-- 2๏ธโฃ ุงูุจุงุฆุนูู ูุฑูู ููุชุฌุงุชูู (ุจุบุถ ุงููุธุฑ ุนู ุงูุญุงูุฉ)
CREATE POLICY "vendor_view_own_products" ON products 
  FOR SELECT 
  USING (vendor_id IN (SELECT id FROM stores WHERE user_id = auth.uid()));

-- 3๏ธโฃ ุงูุจุงุฆุนูู ูุณุชุทูุนูู ุงูุฅุฏุฑุงุฌ
CREATE POLICY "vendor_insert_products" ON products 
  FOR INSERT 
  WITH CHECK (vendor_id IN (SELECT id FROM stores WHERE user_id = auth.uid()));

-- 4๏ธโฃ ุงูุจุงุฆุนูู ูุณุชุทูุนูู ุงูุชุนุฏูู
CREATE POLICY "vendor_update_own_products" ON products 
  FOR UPDATE 
  USING (vendor_id IN (SELECT id FROM stores WHERE user_id = auth.uid()));

-- 5๏ธโฃ ุงูุจุงุฆุนูู ูุณุชุทูุนูู ุงูุญุฐู
CREATE POLICY "vendor_delete_own_products" ON products 
  FOR DELETE 
  USING (vendor_id IN (SELECT id FROM stores WHERE user_id = auth.uid()));

-- 6๏ธโฃ ุงููุณุคูููู ูุฏููุฑูู ุงููู
CREATE POLICY "admin_manage_all_products" ON products 
  FOR ALL 
  USING ((SELECT role FROM users WHERE id = auth.uid()) = 'admin');
```

**ุงููุงุฆุฏุฉ:**
- ุงูุจุงุฆุนูู ุงูุขู ููุฏุฑูู ูุถูููุง ููุชุฌุงุช
- ููุฏุฑูู ูุนุฏููุง ููุญุฐููุง ููุชุฌุงุชูู
- ุณูุงุณุงุช ูุงุถุญุฉ ููููุตูุฉ (ุฃูุถู)

---

### ุงูุฎุทูุฉ 3: Better Error Handling
```typescript
// ูู AuthContext: ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุชููุงุฆูุงู
const fetchUserData = async (uid: string, retryCount = 0) => {
  try {
    const { data, error } = await Promise.race([
      fetchPromise,
      timeoutPromise
    ]);
    
    if (error && retryCount < 1) {
      // ูุญุงููุฉ ุซุงููุฉ ุจุนุฏ 500ms
      await new Promise(resolve => setTimeout(resolve, 500));
      return fetchUserData(uid, retryCount + 1);
    }
  } catch (error) {
    // ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ
    console.error('Failed after retries:', error);
  }
};
```

**ุงููุงุฆุฏุฉ:**
- ุงููุธุงู ูุญุงูู ูุฑุฉ ุซุงููุฉ ุชููุงุฆูุงู
- ูู ูุงูุช ุนูููุฉ ูุคูุชุฉุ ุชูุฌุญ
- ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ูููุณุชุฎุฏู

---

## ุงูุฎุทูุงุช ุงููุทููุจุฉ

### ุงูุฎุทูุฉ 1: ุชุญุฏูุซ SQL ูู Supabase
```
1. ุงุฐูุจ ุฅูู Supabase SQL Editor
2. ุงูุณุฎ ูุญุชูู: database/fix_product_rls_policies.sql
3. ุงูุตู ูุงูุถุบุท Run
4. ุงูุชุธุฑ ุงููุฌุงุญ โ
```

### ุงูุฎุทูุฉ 2: Build ุงููุดุฑูุน
```bash
npm run build
```

### ุงูุฎุทูุฉ 3: Push ุงูุชุบููุฑุงุช
```bash
git add .
git commit -m "Fix product page loading and RLS policies"
git push
```

### ุงูุฎุทูุฉ 4: ุงุฎุชุจุฑ ุงูุขู
```
1. ุงุฐูุจ ุฅูู /dashboard/vendor/products/new
2. ูุฌุจ ุชุญููู ุงูุตูุญุฉ ูู ุซุงููุฉ ุฃู ุซุงููุชูู
3. ุญุงูู ุฅุถุงูุฉ ููุชุฌ
4. ูุฌุจ ุชุญูุธ ุจูุฌุงุญ!
```

---

## โ ุงูุฎุทุฃ ุงูุฐู ูุงู ูุญุฏุซ

### ูุจู ุงูุฅุตูุงุญ:
```
โ ุชุณุฌูู ุงูุฏุฎูู
  โ
โ [ุฌุงุฑู ุงูุชุญูู ูู ุงูุตูุงุญูุงุช...]
  โ
โณ ุงูุงูุชุธุงุฑ 30+ ุซุงููุฉ
  โ
โ [ุฌุงุฑู ุงูุชุญูู ูู ุงูุตูุงุญูุงุช...] (ูุง ูุฒุงู)
  โ
๐ซ ุบุถุจ ุงููุณุชุฎุฏู
```

### ุจุนุฏ ุงูุฅุตูุงุญ:
```
โ ุชุณุฌูู ุงูุฏุฎูู
  โ
โ๏ธ ุงูุชุญูู ูู ุงูุตูุงุญูุงุช (2-3 ุซูุงูู)
  โ
โ ุงูุฏุฎูู ููุตูุญุฉ
  โ
โ ุฅุถุงูุฉ ุงูููุชุฌ ุจูุฌุงุญ!
  โ
๐ ุงููุณุชุฎุฏู ุณุนูุฏ
```

---

## ๐ ุงูุชูุงุตูู ุงูุชูููุฉ

### ูููุงุช ุชู ุชุนุฏูููุง:

1. **components/ProtectedRoute.tsx**
   - ุฅุถุงูุฉ timeout 5 ุซูุงูู
   - ุฃูุถู ูุนุงูุฌุฉ ููุฃุฎุทุงุก
   - ุฑุณุงุฆู ุชุดุฎูุต ูุงุถุญุฉ

2. **contexts/AuthContext.tsx**
   - ุฅุถุงูุฉ timeout 3 ุซูุงูู
   - ุฅุนุงุฏุฉ ูุญุงููุฉ ุชููุงุฆูุฉ
   - handling ุฃูุถู ููุฃุฎุทุงุก

3. **app/dashboard/vendor/products/new/page.tsx**
   - timeout ููู vendor query
   - timeout ููู insert query
   - ุฑุณุงุฆู ุฎุทุฃ ูุญุฏุฏุฉ (RLS, FK, etc)

4. **database/force_rebuild.sql**
   - ุณูุงุณุงุช RLS ุฌุฏูุฏุฉ

5. **database/fix_product_rls_policies.sql** (ุฌุฏูุฏ)
   - ุชุทุจูู ุงูุณูุงุณุงุช ุงูุฌุฏูุฏุฉ ุนูู ุงูู database ุงูุญุงูู

---

## ๐ ุงูุฃุฏุงุก

| ุงูุนูููุฉ | ูุจู | ุจุนุฏ |
|--------|------|------|
| ุชุญููู ุงูุตูุญุฉ | 30+ ุซุงููุฉ (ูุง ุชุญูู) | 2-3 ุซูุงูู โ |
| ุฅุถุงูุฉ ุงูููุชุฌ | โ ูุดู RLS | โ ูุฌุญ |
| ุฑุณุงูุฉ ุงูุฎุทุฃ | ุบูุฑ ูุงุถุญุฉ | ูุงุถุญุฉ ุฌุฏุงู |
| Retry ุชููุงุฆู | ูุง | ูุนู โ |

---

## ๐ ูู ูุง ุฒุงูุช ุงููุดููุฉ

ุงุชุจุน ูุฐู ุงูุฎุทูุงุช:

### 1. ุชุญูู ูู ุงูู Console
```
F12 โ Console
ุงุจุญุซ ุนู ุฑุณุงุฆู ุงูุฎุทุฃ ุงูุญูุฑุงุก
ุงูุณุฎูุง ูุฃุฑุณููุง
```

### 2. ุชุญูู ูู ุงูู Network
```
F12 โ Network
ุฃุถู ููุชุฌ
ุงุจุญุซ ุนู request ุจุญูุฑุงุก
ุงููุฑ ุนููู ูุดูู ุงูู Response
```

### 3. ุชุญูู ูู Database
```
Supabase โ RLS Policies
ุชุฃูุฏ ูู ูุฌูุฏ ุงูุณูุงุณุงุช ุงูุฌุฏูุฏุฉ
```

### 4. ุฃุนุฏ ุชุญููู Schema Cache
```
Supabase โ Settings โ API
ุงุถุบุท "Reload schema cache"
ุงูุชุธุฑ 10 ุซูุงูู
```

---

## ๐ ุงูุฏุนู

ูู ูุง ุฒุงูุช ุงููุดููุฉ:

1. **ุชุญูู ูู ุงูู logs** - ุงุถุบุท F12 ูุฑุงุฌุน Console
2. **ุชุญูู ูู ุงูู database** - ูู ุงูุจูุงูุงุช ููุฌูุฏุฉุ
3. **ุฃุนุฏ ุงูุชุญููู** - Ctrl+Shift+R (Hard Refresh)
4. **ุฃุนุฏ ุงููุดุฑ** - `git push` ูุฑุฉ ุฃุฎุฑู

---

**ุงูุขู ุงููุธุงู ุฌุงูุฒ! โจ**
