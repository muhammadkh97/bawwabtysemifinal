-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ”§ Ø¥ØµÙ„Ø§Ø­ Ø³ÙŠØ§Ø³Ø© RLS Ù„Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª (Ù†Ø³Ø®Ø© Ù…ÙØµÙ„Ø­Ø©)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
-- âœ… Ø­Ø°Ù Ø§Ù„Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…ÙØµÙ„Ø­Ø©
-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

-- Ø­Ø°Ù Ø§Ù„Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
DROP POLICY IF EXISTS "Users can accept staff invitations" ON vendor_staff;

-- Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙŠØ§Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…ÙØµÙ„Ø­Ø© (ØªØ³ØªØ®Ø¯Ù… Ø¬Ø¯ÙˆÙ„ users Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† auth.users)
CREATE POLICY "Users can accept staff invitations"
ON vendor_staff
FOR INSERT
TO public
WITH CHECK (
  user_id = auth.uid()
  AND EXISTS (
    SELECT 1 
    FROM staff_invitations si
    INNER JOIN users u ON u.id = auth.uid() AND u.email = si.email
    WHERE si.business_type = 'vendor'
    AND si.business_id = vendor_staff.vendor_id
    AND si.status = 'pending'
    AND si.expires_at > NOW()
  )
);

-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
-- ğŸ“Š Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

SELECT 
    'âœ… Ø§Ù„Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ù…ÙØµÙ„Ø­Ø©' as info,
    policyname as "Ø§Ø³Ù… Ø§Ù„Ø³ÙŠØ§Ø³Ø©",
    cmd as "Ø§Ù„Ø£Ù…Ø±",
    with_check as "Ø´Ø±Ø· WITH CHECK"
FROM pg_policies
WHERE schemaname = 'public' 
  AND tablename = 'vendor_staff'
  AND policyname = 'Users can accept staff invitations';

-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
-- ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©:
-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

/*
Ø§Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ:
- Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù†: si.email IN (SELECT email FROM auth.users WHERE id = auth.uid())
- Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§: INNER JOIN users u ON u.id = auth.uid() AND u.email = si.email

Ù‡Ø°Ø§ ÙŠØ³ØªØ®Ø¯Ù… Ø¬Ø¯ÙˆÙ„ users Ø§Ù„Ø¹Ø§Ù… (public.users) Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† auth.users Ø§Ù„Ù…Ø­Ù…ÙŠ
*/
